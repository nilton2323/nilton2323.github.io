<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados de Encuesta</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    table {
      border-collapse: collapse;
      width: 90%;
      margin: 20px auto;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f4f4f4;
    }
    #graficos {
      width: 90%;
      margin: 40px auto;
    }
    canvas {
      margin: 30px 0;
    }
    #graficosCirculares {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
    }
    .grafico-circular {
      width: 300px;
      height: auto;
      text-align: center;
    }
    .grafico-circular canvas {
      height: 180px !important;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Resultados de Encuesta</h2>
  <div id="tabla"></div>
  <div id="graficos">
    <canvas id="graficoBarras" height="150"></canvas>
  </div>
  <div id="graficosCirculares"></div> <!-- Sección para los gráficos circulares -->

<script>
  const encabezadosPersonalizados = {
    "p1": "Tengo metas SMART claras a corto...",
    "p2": "Me recupero rápido después de un “no”...",
    "p3": "Me mantengo enfocado y decisivo...",
    "p4": "Tengo conciencia de mis fortalezas...",
    "p5": "Mantengo un equilibrio personal...",
    "p6": "Tengo una rutina semanal de tareas...",
    "p7": "Sé cómo identificar el segmento...",
    "p8": "Aplico los pasos claves..."
  };

  function mostrarDatos(data) {
    const tabla = document.createElement("table");
    const div = document.getElementById("tabla");

    const headerRow = document.createElement("tr");
    data[0].forEach(texto => {
      const th = document.createElement("th");
      th.textContent = encabezadosPersonalizados[texto] || texto;
      headerRow.appendChild(th);
    });
    tabla.appendChild(headerRow);

    for (let i = 1; i < data.length; i++) {
      const fila = document.createElement("tr");
      data[i].forEach(celda => {
        const td = document.createElement("td");
        td.textContent = celda;
        fila.appendChild(td);
      });
      tabla.appendChild(fila);
    }

    div.appendChild(tabla);

    procesarEstadisticas(data);
    generarGraficosCirculares(data);
  }

  function procesarEstadisticas(data) {
    const encabezados = data[0];
    const conteoMayorIgual3 = {};
    const conteoMenor3 = {};

    for (let i = 1; i < encabezados.length; i++) {
      const pregunta = encabezados[i];
      conteoMayorIgual3[pregunta] = 0;
      conteoMenor3[pregunta] = 0;
    }

    for (let i = 1; i < data.length; i++) {
      for (let j = 1; j < data[i].length; j++) {
        const valor = parseFloat(data[i][j]);
        const pregunta = encabezados[j];
        if (!isNaN(valor)) {
          if (valor >= 3) {
            conteoMayorIgual3[pregunta]++;
          } else {
            conteoMenor3[pregunta]++;
          }
        }
      }
    }

    const labels = Object.keys(conteoMayorIgual3).map(
      clave => encabezadosPersonalizados[clave] || clave
    );
    const datosMayores = Object.values(conteoMayorIgual3);
    const datosMenores = Object.values(conteoMenor3);

    const ctx = document.getElementById("graficoBarras").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Respuestas ≥ 3",
            data: datosMayores,
            backgroundColor: "rgba(54, 162, 235, 0.7)",
          },
          {
            label: "Respuestas < 3",
            data: datosMenores,
            backgroundColor: "rgba(255, 99, 132, 0.7)",
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: "Análisis de Resultados por Pregunta",
            font: { size: 18 }
          }
        },
        scales: {
          y: { beginAtZero: true, stepSize: 1 }
        }
      }
    });
  }

  function generarGraficosCirculares(data) {
    const encabezados = data[0];
    const contenedor = document.getElementById("graficosCirculares");
    contenedor.innerHTML = "";

    for (let j = 1; j < encabezados.length; j++) {
      const pregunta = encabezados[j];
      const conteo = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

      for (let i = 1; i < data.length; i++) {
        const valor = parseInt(data[i][j]);
        if (!isNaN(valor) && conteo.hasOwnProperty(valor)) {
          conteo[valor]++;
        }
      }

      const wrapper = document.createElement("div");
      wrapper.className = "grafico-circular";

      const canvas = document.createElement("canvas");
      wrapper.appendChild(canvas);
      contenedor.appendChild(wrapper);

      new Chart(canvas.getContext("2d"), {
        type: "pie",
        data: {
          labels: ["1", "2", "3", "4", "5"],
          datasets: [{
            label: "Distribución de respuestas",
            data: Object.values(conteo),
            backgroundColor: [
              "#FF6384", "#FFCD56", "#4BC0C0", "#36A2EB", "#9966FF"
            ]
          }]
        },
        options: {
          plugins: {
            title: {
              display: true,
              text: encabezadosPersonalizados[pregunta] || pregunta,
              font: { size: 16 }
            }
          }
        }
      });
    }
  }

  const script = document.createElement("script");
  script.src = "https://script.google.com/macros/s/AKfycbxRXiNZQDUu7SlrtGPVtQfwenMwqU30OKozMdy-k-H_XpRjRIFhpzX7LsARSBXimeHI/exec?callback=mostrarDatos";
  document.body.appendChild(script);
</script>

</body>
</html>
